<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN">
<!-- Created by htmlize-1.51 in css mode. -->
<html>
  <head>
    <title>simulation-setup.R</title>
    <style type="text/css">
    <!--
      body {
        color: #121212;
        background-color: #ffffff;
      }
      .bold {
        /* bold */
        font-weight: bold;
      }
      .comment {
        /* font-lock-comment-face */
        color: #4a708b;
      }
      .comment-delimiter {
        /* font-lock-comment-delimiter-face */
        color: #4a708b;
      }
      .keyword {
        /* font-lock-keyword-face */
        color: #a020f0;
      }
      .string {
        /* font-lock-string-face */
        color: #8b2252;
      }
      .type {
        /* font-lock-type-face */
        color: #228b22;
      }
      .variable-name {
        /* font-lock-variable-name-face */
        color: #a0522d;
      }

      a {
        color: inherit;
        background-color: inherit;
        font: inherit;
        text-decoration: inherit;
      }
      a:hover {
        text-decoration: underline;
      }
    -->
    </style>
  </head>
  <body>
    <pre>
<span class="comment-delimiter"><span class="bold">#</span></span><span class="comment"><span class="bold">'</span></span><span class="comment"> Set up graph file to run simulations upon 
</span><span class="comment-delimiter"><span class="bold">#</span></span><span class="comment"><span class="bold">'</span></span><span class="comment">
</span><span class="comment-delimiter"><span class="bold">#</span></span><span class="comment"><span class="bold">'</span></span><span class="comment"> </span><span class="comment"><span class="keyword">@details</span></span><span class="comment">
</span><span class="comment-delimiter"><span class="bold">#</span></span><span class="comment"><span class="bold">'</span></span><span class="comment"> 1. Reads in an `igraph` object (with commuting proportions previously
</span><span class="comment-delimiter"><span class="bold">#</span></span><span class="comment"><span class="bold">'</span></span><span class="comment">      calculated)
</span><span class="comment-delimiter"><span class="bold">#</span></span><span class="comment"><span class="bold">'</span></span><span class="comment"> 
</span><span class="comment-delimiter"><span class="bold">#</span></span><span class="comment"><span class="bold">'</span></span><span class="comment"> 2. Calculates and attaches  "Effective Population" to graph
</span><span class="comment-delimiter"><span class="bold">#</span></span><span class="comment"><span class="bold">'</span></span><span class="comment"> 
</span><span class="comment-delimiter"><span class="bold">#</span></span><span class="comment"><span class="bold">'</span></span><span class="comment"> 3. Vaccinates target nodes with vaccination proportion:
</span><span class="comment-delimiter"><span class="bold">#</span></span><span class="comment"><span class="bold">'</span></span><span class="comment">    vaccination proportions = vaccination coverage * vaccination efficacy
</span><span class="comment-delimiter"><span class="bold">#</span></span><span class="comment"><span class="bold">'</span></span><span class="comment">    The proportion of a node that is vaccinated is removed from the
</span><span class="comment-delimiter"><span class="bold">#</span></span><span class="comment"><span class="bold">'</span></span><span class="comment">    Susceptible compartment and added to the Recovered compartment
</span><span class="comment-delimiter"><span class="bold">#</span></span><span class="comment"><span class="bold">'</span></span><span class="comment"> 
</span><span class="comment-delimiter"><span class="bold">#</span></span><span class="comment"><span class="bold">'</span></span><span class="comment"> 3. Seeds a node with specified number of infectious individuals (taking them
</span><span class="comment-delimiter"><span class="bold">#</span></span><span class="comment"><span class="bold">'</span></span><span class="comment">      out from the Susceptibles and adding to Infectious compartment
</span><span class="comment-delimiter"><span class="bold">#</span></span><span class="comment"><span class="bold">'</span></span><span class="comment"> 
</span><span class="comment-delimiter"><span class="bold">#</span></span><span class="comment"><span class="bold">'</span></span><span class="comment"> 4. Creates the FOI structure/scaffold used to quickly calculate FOI
</span><span class="comment-delimiter"><span class="bold">#</span></span><span class="comment"><span class="bold">'</span></span><span class="comment">      (FOI = Force of Infection, acting on an individual in a node)
</span><span class="comment-delimiter"><span class="bold">#</span></span><span class="comment"><span class="bold">'</span></span><span class="comment">
</span><span class="comment-delimiter"><span class="bold">#</span></span><span class="comment"><span class="bold">'</span></span><span class="comment"> </span><span class="comment"><span class="keyword"><span class="keyword">@param</span></span></span><span class="comment"> </span><span class="comment"><span class="variable-name">g</span></span><span class="comment"> The network object created after commuting rates were calculated
</span><span class="comment-delimiter"><span class="bold">#</span></span><span class="comment"><span class="bold">'</span></span><span class="comment"> </span><span class="comment"><span class="keyword"><span class="keyword">@param</span></span></span><span class="comment"> </span><span class="comment"><span class="variable-name">r0</span></span><span class="comment"> Reproduction number
</span><span class="comment-delimiter"><span class="bold">#</span></span><span class="comment"><span class="bold">'</span></span><span class="comment"> </span><span class="comment"><span class="keyword"><span class="keyword">@param</span></span></span><span class="comment"> </span><span class="comment"><span class="variable-name">latent_period</span></span><span class="comment"> Period between infection and becoming infectious
</span><span class="comment-delimiter"><span class="bold">#</span></span><span class="comment"><span class="bold">'</span></span><span class="comment"> </span><span class="comment"><span class="keyword"><span class="keyword">@param</span></span></span><span class="comment"> </span><span class="comment"><span class="variable-name">inf_period</span></span><span class="comment"> Duration of infectious period
</span><span class="comment-delimiter"><span class="bold">#</span></span><span class="comment"><span class="bold">'</span></span><span class="comment"> </span><span class="comment"><span class="keyword"><span class="keyword">@param</span></span></span><span class="comment"> </span><span class="comment"><span class="variable-name">tau</span></span><span class="comment"> Return rate (from commuting)
</span><span class="comment-delimiter"><span class="bold">#</span></span><span class="comment"><span class="bold">'</span></span><span class="comment"> </span><span class="comment"><span class="keyword"><span class="keyword">@param</span></span></span><span class="comment"> </span><span class="comment"><span class="variable-name">r_beta</span></span><span class="comment"> Reduction in infectiousness due to being aymptomatic inf
</span><span class="comment-delimiter"><span class="bold">#</span></span><span class="comment"><span class="bold">'</span></span><span class="comment"> </span><span class="comment"><span class="keyword"><span class="keyword">@param</span></span></span><span class="comment"> </span><span class="comment"><span class="variable-name">p_a</span></span><span class="comment"> Probability of asymptomatic infection
</span><span class="comment-delimiter"><span class="bold">#</span></span><span class="comment"><span class="bold">'</span></span><span class="comment"> </span><span class="comment"><span class="keyword"><span class="keyword">@param</span></span></span><span class="comment"> </span><span class="comment"><span class="variable-name">seed_nd</span></span><span class="comment"> The node which you want to seed/initiate infection in
</span><span class="comment-delimiter"><span class="bold">#</span></span><span class="comment"><span class="bold">'</span></span><span class="comment"> </span><span class="comment"><span class="keyword"><span class="keyword">@param</span></span></span><span class="comment"> </span><span class="comment"><span class="variable-name">seed_no</span></span><span class="comment"> The number of infected people you want to start inf with
</span><span class="comment-delimiter"><span class="bold">#</span></span><span class="comment"><span class="bold">'</span></span><span class="comment"> </span><span class="comment"><span class="keyword"><span class="keyword">@param</span></span></span><span class="comment"> </span><span class="comment"><span class="variable-name">vacc</span></span><span class="comment"> Whether a vaccination campaign is underway or not
</span><span class="comment-delimiter"><span class="bold">#</span></span><span class="comment"><span class="bold">'</span></span><span class="comment"> </span><span class="comment"><span class="keyword"><span class="keyword">@param</span></span></span><span class="comment"> </span><span class="comment"><span class="variable-name">output_dir</span></span><span class="comment"> Directory to store intermediate simulation data in.
</span><span class="comment-delimiter"><span class="bold">#</span></span><span class="comment"><span class="bold">'</span></span><span class="comment"> </span><span class="comment"><span class="keyword"><span class="keyword">@param</span></span></span><span class="comment"> </span><span class="comment"><span class="variable-name">vacc_eff</span></span><span class="comment"> Vaccination efficacy
</span><span class="comment-delimiter"><span class="bold">#</span></span><span class="comment"><span class="bold">'</span></span><span class="comment"> </span><span class="comment"><span class="keyword"><span class="keyword">@param</span></span></span><span class="comment"> </span><span class="comment"><span class="variable-name">vacc_cov</span></span><span class="comment"> Vaccination coverage
</span><span class="comment-delimiter"><span class="bold">#</span></span><span class="comment"><span class="bold">'</span></span><span class="comment"> </span><span class="comment"><span class="keyword"><span class="keyword">@param</span></span></span><span class="comment"> </span><span class="comment"><span class="variable-name">vacc_nd</span></span><span class="comment"> Node you want to vaccinate in 
</span><span class="comment-delimiter"><span class="bold">#</span></span><span class="comment"><span class="bold">'</span></span><span class="comment">
</span><span class="comment-delimiter"><span class="bold">#</span></span><span class="comment"><span class="bold">'</span></span><span class="comment"> </span><span class="comment"><span class="variable-name">@export</span></span><span class="comment">
</span><span class="comment-delimiter"><span class="bold">#</span></span><span class="comment"><span class="bold">'</span></span><span class="comment">
</span><span class="comment-delimiter"><span class="bold">#</span></span><span class="comment"><span class="bold">'</span></span><span class="comment"> </span><span class="comment"><span class="keyword">@examples</span></span><span class="comment">
</span><span class="comment-delimiter"><span class="bold">#</span></span><span class="comment"><span class="bold">'</span></span><span class="comment"> f = system.file("sampleData", "g.rds", package = "disnet")
</span><span class="comment-delimiter"><span class="bold">#</span></span><span class="comment"><span class="bold">'</span></span><span class="comment"> g = readRDS(f)
</span><span class="comment-delimiter"><span class="bold">#</span></span><span class="comment"><span class="bold">'</span></span><span class="comment"> g_comm = disnet_commuting(g)
</span><span class="comment-delimiter"><span class="bold">#</span></span><span class="comment"><span class="bold">'</span></span><span class="comment"> nodes = igraph::vcount(g_comm)
</span><span class="comment-delimiter"><span class="bold">#</span></span><span class="comment"><span class="bold">'</span></span><span class="comment"> set.seed(890)
</span><span class="comment-delimiter"><span class="bold">#</span></span><span class="comment"><span class="bold">'</span></span><span class="comment"> seed_nd = igraph::vertex_attr(g_comm, "name", sample(1:nodes, 1))
</span><span class="comment-delimiter"><span class="bold">#</span></span><span class="comment"><span class="bold">'</span></span><span class="comment"> for_sim = disnet_sim_setup(g_comm, seed_nd = seed_nd, output_dir = NA)
</span>


disnet_sim_setup = <span class="keyword">function</span>(g,
                            r0 = 1.44,            <span class="comment-delimiter"># </span><span class="comment">Pourbohloul
</span>                            latent_period = 2.62, <span class="comment-delimiter"># </span><span class="comment">Tuite
</span>                            inf_period = 3.38,    <span class="comment-delimiter"># </span><span class="comment">Tuite
</span>                            tau = 3,              <span class="comment-delimiter"># </span><span class="comment">Return rate
</span>                            r_beta = 0.50,        <span class="comment-delimiter"># </span><span class="comment">Longini 2005
</span>                            p_a = 1/3,            <span class="comment-delimiter"># </span><span class="comment">Lonigni 2005
</span>                            seed_nd = <span class="type">NA</span>, 
                            seed_no = 1,
                            vacc = <span class="type">FALSE</span>,
                            output_dir = getOption(<span class="string">"disnetOutputDir"</span>, <span class="type">NA</span>),
                            vacc_eff = c(80, 90),
                            vacc_cov = c(80, 100),
                            vacc_nd = <span class="string">"890"</span>,
                            ...)
{
    <span class="keyword">if</span>( is.na(seed_nd) ) <span class="keyword">stop</span>(<span class="string">"Please provide seed node"</span>)
    mu = 1/inf_period
    beta = (r0 * mu)/((r_beta * p_a) + (1 - p_a)) <span class="comment-delimiter"># </span><span class="comment">from balcan pg 143
</span>
    <span class="comment-delimiter"># </span><span class="comment">Calculate effective population and add it as a vertex attribute to graph
</span>    g = disnet_eff_pop(g, tau)

    <span class="comment-delimiter"># </span><span class="comment">Calculate sigma by tau values (to avoid recalculation each time)
</span>    g = disnet_add_sigmas(g, tau)

    <span class="comment-delimiter"># </span><span class="comment">Force of infection: May the force be with you ^^ *************************
</span>    vert_info = disnet_vert_info(g, beta)

    <span class="comment-delimiter"># </span><span class="comment">j_in information for lambda_jj part of FOI formula
</span>    j_in = disnet_j_in(vert_info, g)

    <span class="comment-delimiter"># </span><span class="comment">j_out information for lambda_ji part of FOI formula
</span>    j_out = disnet_j_out(vert_info, g)

    <span class="comment-delimiter"># </span><span class="comment">component 1 and 2 (sub)
</span>    comp1_sub = 1/vert_info$sigma_by_tau_p1
    comp2_sub = lapply(setNames(j_in, names(j_in)), disnet_comp2_sub)

    <span class="comment-delimiter"># </span><span class="comment">Defining vert_list, which contains all information needed for FOI
</span>    vert_list = list(vert_info = vert_info,
                     comp1_sub = comp1_sub,
                     comp2_sub = comp2_sub,
                     j_in = j_in,
                     j_out = j_out)

    <span class="comment-delimiter"># </span><span class="comment">Saving pre-simulation parameters
</span>    params = list(exit_latent_I = ((1/latent_period) * (1 - p_a)),
                  exit_latent_Ia =  ((1/latent_period) * p_a),
                  mu = 1/inf_period)


    <span class="comment-delimiter"># </span><span class="comment">Initializing the Time Step list and data frame ***************************
</span>    start_TS = disnet_start_TS(g)

    <span class="comment-delimiter"># </span><span class="comment">Check if vaccination is to take place and proceed accordingly ************
</span>    <span class="keyword">if</span>(vacc){

        <span class="comment-delimiter"># </span><span class="comment">VACCINATION CAMPAIGN IS ON *******************************************
</span>        comb = expand.grid(vacc_eff, vacc_cov)
        vacc_prop = (comb$Var1 * comb$Var2)/10000

        <span class="comment-delimiter"># </span><span class="comment">Transfer effectively vaccinated folks from Susceptible to Recovered cpt
</span>        start_TS = lapply(vacc_prop, <span class="keyword">function</span>(vacc_prop, start_TS, vacc_nd) {
            vacc_rows = which(start_TS$name %<span class="keyword">in</span>% vacc_nd)
            old_S = start_TS$S[ vacc_rows ]
            new_R = round(old_S * vacc_prop)
            start_TS$S[ vacc_rows ] = old_S - new_R
            start_TS$R [ vacc_rows ] = start_TS$R [ vacc_rows ] + new_R
            start_TS
        }, start_TS, vacc_nd)
        
        names(start_TS) = as.character(vacc_prop)

        <span class="comment-delimiter"># </span><span class="comment">Seeding node of interest
</span>        start_TS = lapply(start_TS, <span class="keyword">function</span>(start_TS, seed_nd, seed_no) {
            disnet_seed_nd(start_TS, seed_nd, seed_no)
        }, seed_nd, seed_no)

        <span class="comment-delimiter"># </span><span class="comment">calculate starting foi
</span>        start_TS = lapply(start_TS, <span class="keyword">function</span>(start_TS, vert_list, j_out) {
            start_TS$foi = disnet_foi(start_TS, vert_list, j_out)
            start_TS
        }, vert_list, j_out)

        <span class="comment-delimiter"># </span><span class="comment">Saving pre-simulation scaffold
</span>        sim_input = lapply(start_TS, <span class="keyword">function</span>(start_TS, ...) {
            list(start_TS = start_TS,
                 vert_list = vert_list,
                 j_out = j_out,
                 params = params)
        }, vert_list, j_out, params)

        names(sim_input) = names(start_TS)
        
    } <span class="keyword">else</span> {

        <span class="comment-delimiter"># </span><span class="comment">NO VACCINATION UNDERTAKEN ********************************************
</span>        <span class="comment-delimiter"># </span><span class="comment">Seeding node of interest
</span>        start_TS = disnet_seed_nd(start_TS, seed_nd, seed_no)

        start_TS$foi = disnet_foi(start_TS, vert_list, j_out)

        <span class="comment-delimiter"># </span><span class="comment">Saving pre-simulation scaffold
</span>        sim_input = list(
                        start_TS = start_TS,
                        vert_list = vert_list,
                        j_out = j_out,
                        params = params)

        <span class="comment-delimiter"># </span><span class="comment">if( !dir.exists(dir.save) ) dir.create(dir.save)
</span>
        <span class="comment-delimiter"># </span><span class="comment">sim_input_name = sprintf("/intermed_seed-%s-in-%s.RDS",
</span>        <span class="comment-delimiter"># </span><span class="comment">seed_no,
</span>        <span class="comment-delimiter"># </span><span class="comment">paste0(seed_nd, collapse = "-"))
</span>        <span class="comment-delimiter"># </span><span class="comment">saveRDS(sim_input, paste0(dir.save, sim_input_name))
</span>    }
    
    <span class="keyword">if</span>(length(output_dir) &gt; 0 &amp;&amp; !is.na(output_dir)) {

        <span class="keyword">if</span>(!dir.exists(output_dir)) dir.create(output_dir)

        <span class="keyword">if</span>(vacc) {
            vacc_prop = gsub(<span class="string">"\\."</span>, <span class="string">"p"</span>, names(sim_input))
            f = file.path(output_dir, sprintf(<span class="string">"%d_sim-setup_seed-%s_vacc-%s-%s.RDS"</span>,
                                              seq_along(sim_input),
                                              paste0(seed_nd, collapse = <span class="string">"-"</span>),
                                              paste0(vacc_nd, collapse = <span class="string">"-"</span>),
                                              vacc_prop))
            
            lapply(seq_along(sim_input), <span class="keyword">function</span>(n, sim_input, f, ...)
            {
                sim_input = sim_input[[n]]
                saveRDS(sim_input, f[[n]])
            }, sim_input, f)
        } <span class="keyword">else</span> {
            f = file.path(output_dir,
                          sprintf(<span class="string">"sim-setup_seed-%s-in-%s.RDS"</span>,
                                  seed_no,
                                  paste0(seed_nd, collapse = <span class="string">"-"</span>)))
            saveRDS(sim_input, f)
        }
        f
    } <span class="keyword">else</span> {
        sim_input
    }
}




<span class="comment-delimiter"># </span><span class="comment">==============================================================================
</span><span class="comment-delimiter"># </span><span class="comment">for code testing
</span><span class="comment-delimiter"># </span><span class="comment">==============================================================================
</span><span class="comment-delimiter"># </span><span class="comment">VACCINATION: NO
</span><span class="keyword">if</span>(<span class="type">FALSE</span>){
    r0 = 1.44            <span class="comment-delimiter"># </span><span class="comment">Pourbohloul
</span>    latent_period = 2.62 <span class="comment-delimiter"># </span><span class="comment">Tuite
</span>    inf_period = 3.38    <span class="comment-delimiter"># </span><span class="comment">Tuite
</span>    tau = 3              <span class="comment-delimiter"># </span><span class="comment">Return rate
</span>    r_beta = 0.50        <span class="comment-delimiter"># </span><span class="comment">Longini 2005
</span>    p_a = 1/3            <span class="comment-delimiter"># </span><span class="comment">Lonigni 2005
</span>    <span class="comment-delimiter"># </span><span class="comment">seed_nd = "885"
</span>    seed_no = 1
    vacc = <span class="type">FALSE</span>
    output_dir = <span class="type">NA</span>
}


<span class="comment-delimiter"># </span><span class="comment">VACCINATION: YES
</span><span class="keyword">if</span>(<span class="type">FALSE</span>){
    r0 = 1.44            <span class="comment-delimiter"># </span><span class="comment">Pourbohloul
</span>    latent_period = 2.62 <span class="comment-delimiter"># </span><span class="comment">Tuite
</span>    inf_period = 3.38    <span class="comment-delimiter"># </span><span class="comment">Tuite
</span>    tau = 3              <span class="comment-delimiter"># </span><span class="comment">Return rate
</span>    r_beta = 0.50        <span class="comment-delimiter"># </span><span class="comment">Longini 2005
</span>    p_a = 1/3            <span class="comment-delimiter"># </span><span class="comment">Lonigni 2005
</span>    <span class="comment-delimiter"># </span><span class="comment">seed_nd = "885"
</span>    seed_no = 1
    vacc = <span class="type">TRUE</span>
    output_dir = getOption(<span class="string">"disnetOutputDir"</span>, <span class="string">"disnet_output_dir"</span>)
    <span class="comment-delimiter"># </span><span class="comment">vacc_eff = c(50, 60, 70, 80, 90)
</span>    <span class="comment-delimiter"># </span><span class="comment">vacc_cov = c(20, 40, 60, 80, 100)
</span>    vacc_eff = c(80, 90)
    vacc_cov = c(80, 100)
    vacc_nd = <span class="string">"890"</span>
}
</pre>
  </body>
</html>
